name: Assaí Encarte Scraper

on:
  schedule:
    - cron: '0 6 * * 1'   # Toda segunda-feira às 6h UTC
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      OUTPUT_DIR: ${{ github.workspace }}/encartes
      SCRIPT_REPO: pedroisonmycomputer/supermercados-code-project
      SCRIPT_PATH: assai.py          # ← ajuste se estiver em sub-pasta (ex: scripts/assai.py)

    steps:
      # -------------------------------------------------
      # 1. Checkout do repositório que contém o workflow
      # -------------------------------------------------
      - name: Checkout Workflow Repo
        uses: actions/checkout@v4
        with:
          path: workflow-repo

      # -------------------------------------------------
      # 2. Checkout do repositório que contém o script
      # -------------------------------------------------
      - name: Checkout Script Repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SCRIPT_REPO }}
          path: script-repo

      # -------------------------------------------------
      # 3. Copiar o script para o diretório de execução
      # -------------------------------------------------
      - name: Copiar assai.py
        run: |
          SRC="script-repo/${{ env.SCRIPT_PATH }}"
          if [ ! -f "$SRC" ]; then
            echo "ERRO: Script não encontrado em $SRC"
            find script-repo -type f | head -20
            exit 1
          fi
          cp "$SRC" ./assai.py
          echo "assai.py copiado com sucesso."

      # -------------------------------------------------
      # 4. Configurar Python
      # -------------------------------------------------
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # -------------------------------------------------
      # 5. Instalar ferramentas do sistema (jq + unzip)
      # -------------------------------------------------
      - name: Instalar jq + unzip
        run: |
          sudo apt update
          sudo apt install -y jq unzip

      # -------------------------------------------------
      # 6. Instalar Chrome + ChromeDriver (chrome-for-testing)
      # -------------------------------------------------
      - name: Instalar Chrome + ChromeDriver
        run: |
          # --- Chrome -------------------------------------------------
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" \
            | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt update
          sudo apt install -y google-chrome-stable

          # --- Versão do Chrome ---------------------------------------
          CHROME_FULL_VER=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+\.\d+' || echo "0.0.0.0")
          MAJOR_VER=$(echo "$CHROME_FULL_VER" | cut -d'.' -f1)
          echo "Chrome detectado: $CHROME_FULL_VER (major $MAJOR_VER)"

          # --- Metadados chrome-for-testing ---------------------------
          JSON_URL="https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json"
          DOWNLOAD_INFO=$(curl -s "$JSON_URL")
          [ -z "$DOWNLOAD_INFO" ] && { echo "Falha ao obter metadados"; exit 1; }

          # --- ChromeDriver exato --------------------------------------
          DRIVER_URL=$(echo "$DOWNLOAD_INFO" | \
            jq -r --arg v "$CHROME_FULL_VER" \
            '.channels.Stable.downloads.chromedriver[]?
             | select(.platform=="linux64")
             | select(.url | contains($v))
             | .url' 2>/dev/null || echo "")

          # --- Fallback: última versão do mesmo major -----------------
          [ -z "$DRIVER_URL" ] && DRIVER_URL=$(echo "$DOWNLOAD_INFO" | \
            jq -r '.channels.Stable.downloads.chromedriver[]?
                   | select(.platform=="linux64")
                   | .url' | head -1)

          # --- Fallback: canal Dev ------------------------------------
          [ -z "$DRIVER_URL" ] && DRIVER_URL=$(echo "$DOWNLOAD_INFO" | \
            jq -r '.channels.Dev.downloads.chromedriver[]?
                   | select(.platform=="linux64")
                   | .url' | head -1)

          [ -z "$DRIVER_URL" ] && { echo "ChromeDriver não encontrado"; exit 1; }

          echo "Baixando ChromeDriver: $DRIVER_URL"
          wget -O /tmp/chromedriver.zip "$DRIVER_URL"
          unzip -o /tmp/chromedriver.zip -d /tmp

          DRIVER_PATH=$(find /tmp -name chromedriver -type f -executable | head -1)
          [ -z "$DRIVER_PATH" ] && { echo "chromedriver não encontrado após unzip"; exit 1; }

          sudo mv "$DRIVER_PATH" /usr/bin/chromedriver
          sudo chmod +x /usr/bin/chromedriver
          echo "ChromeDriver instalado:"
          chromedriver --version

      # -------------------------------------------------
      # 7. Instalar dependências Python
      # -------------------------------------------------
      - name: Instalar dependências Python
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests

      # -------------------------------------------------
      # 8. Executar o scraper
      # -------------------------------------------------
      - name: Executar Assaí Scraper
        run: |
          mkdir -p "$OUTPUT_DIR"
          python assai.py

      # -------------------------------------------------
      # 9. Upload dos encartes
      # -------------------------------------------------
      - name: Upload Encarte
        uses: actions/upload-artifact@v4
        with:
          name: encartes-assai-${{ github.run_attempt }}
          path: ${{ env.OUTPUT_DIR }}/**
          if-no-files-found: warn

      # -------------------------------------------------
      # 10. Upload de debug (apenas se falhar)
      # -------------------------------------------------
      - name: Upload Debug (erro)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-assai-erro-${{ github.run_attempt }}
          path: |
            ${{ env.OUTPUT_DIR }}/ERRO_*.png
            ${{ env.OUTPUT_DIR }}/*.log
            /tmp/*.png
            assai.py
          if-no-files-found: ignore
